---
title: "Manipulating (spatial) data"
output: 
    html_document:
        toc: TRUE
        toc_float: TRUE
---

Two types of data-manipulation: 

1. spatial data-manipulations: spatial cropping, union, aggregation, etc.
2. 'regular' data-manipulations: combine categories, calculate percentage of population, etc.

... but same syntax and in **one** dataframe.

PS: always an option, do (2) in SAS, Stata, etc. before reading and joining data (previous step).

```{r, message=FALSE, warning=FALSE}
library(here)
library(sf)
library(tmap)
library(dplyr)
library(readxl)
library(mapview)
```


```{r, message=FALSE, warning=FALSE, results = 'hide'}
# (1) load spatial data
raillines <- st_read(here('data/source/census_1851_raillines/1851EngWalesScotRail_Lines.shp'))

districts_spatial <- st_read(here('data/source/census_1851_districts/1851EngWalesRegistrationDistrict.shp')) %>%
  mutate(CEN1 = as.numeric(as.character(CEN1))) # make sure identifiers are the same type

# (2) load and add data-of-interest
districts_data <- read_excel(here('data/census1851_districts_count.xlsx'))
districts <- left_join(districts_spatial, districts_data, by = c('CEN1' = 'district_id'))
```


# Data-manipulation on joint dataset

```{r, message=FALSE, warning=FALSE}
districts <- districts %>%
  mutate(pct_prof = tertiary_services_professions / total)
```

```{r, message=FALSE, warning=FALSE}
mapview(districts, zcol = 'pct_prof')
```


# Spatial manipulation on joint dataset

Data-exploration: wat is R_DIV variable?

```{r, message=FALSE, warning=FALSE}
divisions <- districts %>%
  group_by(R_DIV) %>%
  tally()
```

```{r, message=FALSE, warning=FALSE}
divisions
```


```{r, message=FALSE, warning=FALSE}
mapview(divisions)
```

# Spatial / data-manipulation: select districts in Manchester-region

```{r, message=FALSE, warning=FALSE}
nwestern <- districts %>%
  filter(R_DIV == 'NORTH WESTERN')
```

```{r, message=FALSE, warning=FALSE}
# static plot of Manchester districts
qtm(nwestern, fill = 'pct_secondary')
```

```{r, message=FALSE, warning=FALSE}
# interactive plot of Manchester districts
mapview(nwestern, zcol = 'pct_secondary') + raillines
```


